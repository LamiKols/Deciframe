{% extends "base.html" %}

{% block title %}Requirements - {{ case.code }} - DeciFrame{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div data-case-id="{{ case.id }}" style="display: none;"></div>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="text-light">Requirements Generator</h2>
                    <p class="text-muted">Business Case: <strong class="text-info">{{ case.code }} - {{ case.title }}</strong></p>
                </div>
                <a href="{{ url_for('business.view_case', id=case.id) }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Case
                </a>
            </div>

            {% if case.epics %}
            <!-- Saved Requirements Display -->
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h2 class="text-light mb-4">Saved Requirements</h2>
                    <div class="alert alert-success mb-4">
                        <i class="fas fa-check-circle"></i>
                        <strong>Requirements Complete:</strong> This business case has {{ case.epics|length }} generated epics with user stories.
                    </div>
                    
                    <div id="savedRequirements">
                        {% for epic in case.epics %}
                        <div class="card mb-3">
                            <div class="card-header bg-info text-dark">
                                <strong>Epic:</strong> {{ epic.title }}
                            </div>
                            <div class="card-body">
                                <p class="text-light">{{ epic.description }}</p>
                                {% if epic.stories %}
                                <ul class="text-light">
                                    {% for story in epic.stories %}
                                    <li class="mb-2">
                                        <strong class="text-warning">{{ story.title }}</strong>: 
                                        <span class="text-light">{{ story.description }}</span>
                                        <div class="mt-1">
                                            <span class="badge bg-{{ 'danger' if story.priority == 'High' else 'warning' if story.priority == 'Medium' else 'success' }} me-2">
                                                {{ story.priority }}
                                            </span>
                                            <span class="badge bg-secondary">{{ story.effort_estimate }}</span>
                                        </div>
                                        {% if story.acceptance_criteria %}
                                        <div class="text-muted small mt-1">
                                            Criteria: 
                                            {% for criteria in story.acceptance_criteria %}
                                                {{ criteria }}{% if not loop.last %}, {% endif %}
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <div class="mt-4 text-center">
                        {% if current_user.role.value == 'BA' %}
                        <button id="refineRequirementsBtn" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-edit"></i> Refine Requirements
                        </button>
                        {% endif %}
                        <button type="button" class="btn btn-success me-2" onclick="exportExistingRequirements()">
                            <i class="fas fa-download"></i> Export Requirements
                        </button>
                        <a href="{{ url_for('business.view_case', id=case.id) }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Case
                        </a>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- Requirements Generation Wizard -->
            <div class="card bg-dark border-secondary">
                <div class="card-body">
                    <h4 class="mb-3 text-light">Requirements Generator</h4>
                    <p class="text-light mb-4">Answer these questions to help generate comprehensive requirements:</p>
                    
                    {% if config.AI_AVAILABLE %}
                    <button id="aiSuggestAnswersBtn" class="btn btn-info mb-3" data-case-id="{{ case.id }}">
                        <i class="fas fa-magic"></i> AI Draft Requirements
                    </button>
                    <div class="text-muted small mb-3">
                        <i class="fas fa-lightbulb"></i> Let AI help you get started with intelligent requirement suggestions
                    </div>
                    {% else %}
                    <div class="alert alert-warning mb-3">
                        <i class="fas fa-exclamation-triangle"></i> AI Requirements temporarily offline. Please fill manually or contact administrator.
                    </div>
                    {% endif %}
                    
                    <form id="requirementsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">1. What are the major functional requirements?</label>
                                    <textarea class="form-control" id="q1" name="question1" rows="3" placeholder="e.g., User management, data processing, reporting, workflow automation..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">2. What are the user roles & permissions?</label>
                                    <textarea class="form-control" id="q2" name="question2" rows="3" placeholder="e.g., Admin roles, user access levels, permission matrices..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">3. What integration/data-flow needs exist?</label>
                                    <textarea class="form-control" id="q3" name="question3" rows="3" placeholder="e.g., Existing systems, databases, APIs, third-party services..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">4. What are the performance/scalability requirements?</label>
                                    <textarea class="form-control" id="q4" name="question4" rows="3" placeholder="e.g., Response times, concurrent users, data volume, availability..."></textarea>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">5. What reporting/audit needs are required?</label>
                                    <textarea class="form-control" id="q5" name="question5" rows="3" placeholder="e.g., Dashboards, KPI tracking, audit trails, compliance reporting..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">6. What error-handling/validation rules are needed?</label>
                                    <textarea class="form-control" id="q6" name="question6" rows="3" placeholder="e.g., Input validation, error messages, data integrity checks..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">7. What UI/UX/accessibility standards apply?</label>
                                    <textarea class="form-control" id="q7" name="question7" rows="3" placeholder="e.g., Mobile responsiveness, WCAG compliance, user experience requirements..."></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label fw-bold text-light">8. What security/compliance constraints exist?</label>
                                    <textarea class="form-control" id="q8" name="question8" rows="3" placeholder="e.g., Data encryption, access controls, regulatory compliance, audit requirements..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            {% if config.ENABLE_AI_REQS %}
                            <button type="button" id="generateEpicsBtn" class="btn btn-success me-2">
                                <i class="fas fa-cogs"></i> Generate Epics & User Stories
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-secondary" disabled>
                                <i class="fas fa-file-text"></i> Generate Requirements Document (Coming Soon)
                            </button>
                            {% endif %}
                        </div>
                    </form>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body">
                                            <h6 class="card-title text-info">Problem Statement</h6>
                                            <p class="card-text text-light">{{ case.problem.description if case.problem else 'No problem specified' }}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body">
                                            <h6 class="card-title text-info">Proposed Solution</h6>
                                            <p class="card-text text-light">{{ case.solution.description if case.solution else case.description }}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-4">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-info">Investment</h6>
                                            <h5 class="text-danger">{{ org_settings.get_currency_symbol() }}{{ "{:,.2f}".format(case.cost_estimate) }}</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-info">Expected Benefit</h6>
                                            <h5 class="text-success">{{ org_settings.get_currency_symbol() }}{{ "{:,.2f}".format(case.benefit_estimate) }}</h5>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-dark border-secondary">
                                        <div class="card-body text-center">
                                            <h6 class="card-title text-info">ROI</h6>
                                            <h5 class="text-warning">{{ "{:.1f}%".format(case.roi) if case.roi else 'TBD' }}</h5>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-4 text-center">
                                <button class="btn btn-primary" onclick="nextStep(2)">
                                    Continue to Requirements <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Requirements Questions -->
                        <div id="step2" class="wizard-step" style="display: none;">
                            <h4 class="mb-3 text-light">Step 2: Define Your Requirements</h4>
                            <p class="text-muted mb-4">Answer these questions to help generate comprehensive requirements:</p>
                            
                            {% if config.AI_AVAILABLE %}
                            <button id="aiSuggestAnswersBtn" class="btn btn-info mb-3" data-case-id="{{ case.id }}">
                                <i class="fas fa-magic"></i> AI Draft Requirements
                            </button>
                            <div class="text-muted small mb-3">
                                <i class="fas fa-lightbulb"></i> Let AI help you get started with intelligent requirement suggestions
                            </div>
                            {% else %}
                            <div class="alert alert-warning mb-3">
                                <i class="fas fa-exclamation-triangle"></i> AI Requirements temporarily offline. Please fill manually or contact administrator.
                            </div>
                            {% endif %}
                            
                            <form id="requirementsForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">1. What are the major functional requirements?</label>
                                            <textarea class="form-control" id="q1" name="question1" rows="3" placeholder="e.g., User management, data processing, reporting, workflow automation..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">2. What are the user roles & permissions?</label>
                                            <textarea class="form-control" id="q2" name="question2" rows="3" placeholder="e.g., Admin roles, user access levels, permission matrices..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">3. What integration/data-flow needs exist?</label>
                                            <textarea class="form-control" id="q3" name="question3" rows="3" placeholder="e.g., Existing systems, databases, APIs, third-party services..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">4. What are the performance/scalability requirements?</label>
                                            <textarea class="form-control" id="q4" name="question4" rows="3" placeholder="e.g., Response times, concurrent users, data volume, availability..."></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">5. What reporting/audit needs are required?</label>
                                            <textarea class="form-control" id="q5" name="question5" rows="3" placeholder="e.g., Dashboards, KPI tracking, audit trails, compliance reporting..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">6. What error-handling/validation rules are needed?</label>
                                            <textarea class="form-control" id="q6" name="question6" rows="3" placeholder="e.g., Input validation, error messages, data integrity checks..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">7. What UI/UX/accessibility standards apply?</label>
                                            <textarea class="form-control" id="q7" name="question7" rows="3" placeholder="e.g., Mobile responsiveness, WCAG compliance, user experience requirements..."></textarea>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">8. What security/compliance constraints exist?</label>
                                            <textarea class="form-control" id="q8" name="question8" rows="3" placeholder="e.g., Data encryption, access controls, regulatory compliance, audit requirements..."></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 text-center">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="nextStep(1)">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                    {% if config.ENABLE_AI_REQS %}
                                    <button type="button" class="btn btn-primary" onclick="generateTextRequirements()">
                                        <i class="fas fa-file-text"></i> Generate Requirements Document
                                    </button>
                                    {% else %}
                                    <button type="button" class="btn btn-secondary" disabled>
                                        <i class="fas fa-file-text"></i> Generate Requirements Document (Coming Soon)
                                    </button>
                                    {% endif %}
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Step 3: Text Requirements Results -->
                    <div id="textRequirementsResults" style="display: none;">
                        <div class="container">
                            <h2 class="mb-4">Generated Requirements Document</h2>
                            <div id="textRequirementsContent" class="bg-dark text-light p-4 rounded" style="white-space: pre-wrap; font-family: monospace;">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <div class="mt-4 text-center">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="nextStep(2)">
                                    <i class="fas fa-arrow-left"></i> Back to Edit
                                </button>
                                <button type="button" class="btn btn-primary me-2" onclick="generateEpicsFromRequirements()">
                                    <i class="fas fa-magic"></i> Generate Epics & User Stories
                                </button>
                                <button type="button" class="btn btn-success" onclick="downloadTextRequirements()">
                                    <i class="fas fa-download"></i> Download as Text
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 4: Loading State for Epics -->
                    <div id="loadingEpicsState" style="display: none;" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">AI is analyzing your requirements and generating user stories and epics...</p>
                    </div>
                    
                    <!-- Step 5: Epics Results -->
                    <div id="epicRequirementsResults" style="display: none;">
                        <div class="container">
                            <h2 class="mb-4">Generated Epics & User Stories</h2>
                            <div id="epicRequirementsContent">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                            
                            <div class="mt-4 text-center">
                                <button type="button" class="btn btn-outline-secondary me-2" onclick="backToTextRequirements()">
                                    <i class="fas fa-arrow-left"></i> Back to Requirements
                                </button>
                                <button type="button" class="btn btn-success" onclick="downloadRequirements()">
                                    <i class="fas fa-download"></i> Download as Text
                                </button>
                            </div>
                        </div>
                    </div>

                        <!-- Step 3: Generated Requirements -->
                        <div id="step3" class="wizard-step" style="display: none;">
                            <h4 class="mb-3 text-light">Step 3: Generated Requirements</h4>
                            
                            <!-- Loading State -->
                            <div id="loadingState" class="text-center py-5" style="display: none;">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Generating requirements...</span>
                                </div>
                                <p class="mt-3">AI is analyzing your requirements and generating epics and user stories...</p>
                            </div>
                            
                            <!-- Results -->
                            <div id="requirementsResults" style="display: none;">
                                <div class="alert alert-info mb-4">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Generated Requirements:</strong> Review the epics and user stories below. You can refine them before proceeding to implementation planning.
                                </div>
                                
                                <div id="epicsContainer">
                                    <!-- Epics will be populated here -->
                                </div>
                                
                                <div class="mt-4 text-center">
                                    <button type="button" class="btn btn-outline-secondary me-2" onclick="nextStep(2)">
                                        <i class="fas fa-arrow-left"></i> Regenerate
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="exportRequirements()">
                                        <i class="fas fa-download"></i> Export Requirements
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="createProject()">
                                        <i class="fas fa-project-diagram"></i> Create Project
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI Requirements Wizard Modal -->
<div class="modal fade" id="aiReqModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-robot"></i> AI Requirements Wizard
                    <span class="badge bg-primary ms-2" id="wizardProgress">Step 1 of 8</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="wizard-question" class="mb-3">
                    <h6 class="text-primary" id="questionTitle">Major functional requirements?</h6>
                    <p class="text-muted" id="questionText">What are the main features and capabilities this system needs to provide?</p>
                </div>
                <textarea id="wizard-answer" class="form-control mb-2" rows="4" placeholder="Type your answer here..."></textarea>
                <div class="progress mb-3" style="height: 6px;">
                    <div class="progress-bar" id="wizardProgressBar" role="progressbar" style="width: 12.5%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="prevStepBtn" class="btn btn-outline-light" disabled>
                    <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button type="button" id="nextStepBtn" class="btn btn-primary">
                    Next <i class="fas fa-arrow-right"></i>
                </button>
                <button type="button" id="finishWizardBtn" class="btn btn-success" style="display: none;">
                    <i class="fas fa-check"></i> Generate Requirements
                </button>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
let currentStep = 1;
let generatedEpics = [];

// AI Wizard functions integrated here
function startWizard() {
    console.log('Starting AI Wizard');
    wizardStep = 0;
    wizardAnswers = [];
    
    const modal = new bootstrap.Modal(document.getElementById('aiReqModal'));
    modal.show();
    
    // Initialize the wizard display when modal opens
    setTimeout(() => {
        updateWizardQuestion();
    }, 100);
}

// Initialize AI Draft Requirements functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, initializing AI draft requirements');
    
    const aiButton = document.getElementById('aiSuggestAnswersBtn');
    if (aiButton) {
        console.log('AI suggest answers button found');
        // Clear any existing event listeners
        aiButton.onclick = async () => {
            try {
                const caseId = document.querySelector('[data-case-id]').getAttribute('data-case-id');
                const res = await fetch('/api/ai/suggest-requirements-answers', {
                    method: 'POST',
                    credentials: 'same-origin',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ case_id: parseInt(caseId) })
                });
                
                if (!res.ok) {
                    const payload = await res.json().catch(() => ({}));
                    alert(payload.error || 'Failed to generate requirements answers.');
                    return;
                }
                
                const { answers } = await res.json();
                answers.forEach((ans, i) => {
                    const el = document.getElementById(`q${i+1}`);
                    if (el) el.value = ans;
                });
                
                showAlert('AI Draft Complete! Review and modify the populated requirements below.', 'success');
            } catch (err) {
                console.error('AI suggestion error', err);
                alert('Failed to fetch AI suggestions. Please try again or fill out manually.');
            }
        };
    } else {
        console.log('AI suggest answers button not found');
    }
});

function generateAIDraftRequirements() {
    const caseId = document.querySelector('[data-case-id]').getAttribute('data-case-id');
    const submitBtn = document.getElementById('aiSuggestAnswersBtn');
    
    if (!submitBtn) {
        console.error('AI suggest answers button not found');
        return;
    }
    
    // Show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI Drafting...';
    submitBtn.disabled = true;
    
    // Get auth token for API call
    const authToken = new URLSearchParams(window.location.search).get('auth_token');
    
    // Call the AI suggestions API
    fetch('/api/ai/suggest-requirements-answers', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            case_id: parseInt(caseId)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('AI Draft response:', result);
        if (result.success && result.answers) {
            populateFormWithAIAnswers(result.answers);
            showAlert('AI Draft Complete! Review and modify the populated requirements below.', 'success');
        } else {
            showAlert('Failed to generate AI draft: ' + (result.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Failed to generate AI draft. Using fallback requirements.', 'warning');
        populateFormWithFallback();
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function populateFormWithAIAnswers(answers) {
    // Map answers to specific textarea IDs (q1, q2, q3, etc.)
    const textareaIds = ['q1', 'q2', 'q3', 'q4', 'q5', 'q6', 'q7', 'q8'];
    
    // Populate each textarea with corresponding AI answer
    answers.forEach((answer, index) => {
        if (index < textareaIds.length) {
            const textarea = document.getElementById(textareaIds[index]);
            if (textarea) {
                textarea.value = answer;
                // Add visual indicator for AI-populated fields
                textarea.style.borderLeft = '3px solid #28a745';
                textarea.style.backgroundColor = 'rgba(40, 167, 69, 0.1)';
            }
        }
    });
    
    // Scroll to form for user review
    const form = document.getElementById('requirementsForm');
    if (form) {
        form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function populateFormWithFallback() {
    const fallbackAnswers = [
        "Core system functionality including automated workflow management, document processing, user portal access, data validation, approval workflows, compliance checking, comprehensive dashboards, and audit trail capabilities.",
        "Multi-tier access: System Administrators (full access), Department Managers (process management), Operations Staff (daily operations), Review Committee (evaluations), External Users (submissions/tracking). Role-based permissions aligned with organizational hierarchy.",
        "Enterprise ERP integration for budget validation, Active Directory authentication, email notifications, document management systems, workflow engines, business intelligence tools, and regulatory systems.",
        "Support 200+ concurrent users, handle 50MB uploads within 15 seconds, maintain 99% uptime, real-time notifications under 3 seconds, auto-scaling capabilities, and sub-2-second response times for standard operations.",
        "Executive dashboards with performance metrics, cost-benefit tracking, compliance reporting, timeline monitoring, and tamper-proof audit trails with comprehensive logging capabilities.",
        "Real-time validation with contextual errors, automated policy checking, duplicate prevention, file format validation, mandatory field enforcement, data integrity checks, graceful error recovery, and comprehensive logging.",
        "Mobile-responsive design, WCAG 2.1 AA compliance, intuitive role-based dashboards, multi-language support, modern branding, keyboard navigation, screen reader compatibility, and offline critical function capability.",
        "Multi-factor authentication, AES-256 encryption, role-based access controls, comprehensive audit logging, regulatory compliance, secure APIs, regular security assessments, and appropriate investment-level security measures."
    ];
    
    populateFormWithAIAnswers(fallbackAnswers);
}

function previousWizardStep() {
    wizardAnswers[wizardStep] = document.getElementById('wizard-answer').value;
    if (wizardStep > 0) {
        wizardStep--;
        updateWizardQuestion();
    }
}

function nextWizardStep() {
    const answer = document.getElementById('wizard-answer').value.trim();
    if (!answer) {
        alert('Please provide an answer before continuing.');
        return;
    }
    
    wizardAnswers[wizardStep] = answer;
    if (wizardStep < wizardQuestions.length - 1) {
        wizardStep++;
        updateWizardQuestion();
    }
}

function finishWizard() {
    const answer = document.getElementById('wizard-answer').value.trim();
    if (!answer) {
        alert('Please provide an answer before finishing.');
        return;
    }
    
    wizardAnswers[wizardStep] = answer;
    
    // Populate the main form with answers
    const textareas = document.querySelectorAll('#requirementsForm textarea');
    wizardAnswers.forEach((answer, index) => {
        if (index < textareas.length && answer.trim()) {
            textareas[index].value = answer;
        }
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('aiReqModal'));
    modal.hide();
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <strong>Wizard Complete!</strong> Your answers have been populated in the form. You can now generate detailed requirements.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const step2 = document.getElementById('step2');
    if (step2) {
        step2.insertBefore(alert, step2.querySelector('form'));
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }
    
    // Reset wizard for next use
    wizardStep = 0;
    wizardAnswers = [];
}

function nextStep(step) {
    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(el => el.style.display = 'none');
    
    // Show target step
    document.getElementById('step' + step).style.display = 'block';
    currentStep = step;
}

function generateRequirements() {
    // Collect form data
    const form = document.getElementById('requirementsForm');
    const formData = new FormData(form);
    const answers = [];
    
    for (let [key, value] of formData.entries()) {
        if (value.trim()) {
            answers.push(value.trim());
        }
    }
    
    if (answers.length === 0) {
        alert('Please provide at least one requirement before generating.');
        return;
    }
    
    // Show loading state
    nextStep(3);
    document.getElementById('loadingState').style.display = 'block';
    document.getElementById('requirementsResults').style.display = 'none';
    
    // Make API call
    fetch(`/api/ai/generate-requirements-demo/{{ case.id }}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            answers: answers,
            case_id: {{ case.id }}
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingState').style.display = 'none';
        
        if (data.success) {
            generatedEpics = data.epics;
            displayRequirements(data.epics, data.message && data.message.includes('demo'));
            document.getElementById('requirementsResults').style.display = 'block';
            showSuccessNotification(data.message || 'Requirements generated and saved successfully!');
        } else {
            alert('Error generating requirements: ' + data.error);
            nextStep(2);
        }
    })
    .catch(error => {
        document.getElementById('loadingState').style.display = 'none';
        console.error('Error generating requirements:', error);
        alert('Failed to generate requirements. Please try again.');
        nextStep(2);
    });
}

function displayRequirements(epics, isFallback = false) {
    const container = document.getElementById('epicRequirementsContent');
    console.log('displayRequirements called with:', epics);
    console.log('Container found:', container);
    
    let html = '';
    
    if (isFallback) {
        html += `<div class="alert alert-warning mb-3">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Note:</strong> Requirements generated using fallback system. Consider providing an OpenAI API key for enhanced AI generation.
        </div>`;
    }
    
    epics.forEach((epic, epicIndex) => {
        html += `
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group"></i> Epic ${epicIndex + 1}: ${epic.title}
                </h5>
                <p class="mb-0 small">${epic.description}</p>
            </div>
            <div class="card-body">
                <div class="row">
        `;
        
        const stories = epic.stories || epic.user_stories || [];
        stories.forEach((story, storyIndex) => {
            const priorityClass = story.priority === 'High' ? 'danger' : 
                                story.priority === 'Medium' ? 'warning' : 'secondary';
            
            html += `
            <div class="col-md-6 mb-3">
                <div class="card border-${priorityClass}">
                    <div class="card-header bg-dark">
                        <h6 class="mb-0 text-light">
                            <span class="badge bg-${priorityClass}">${story.priority}</span>
                            ${story.title}
                        </h6>
                        <small class="text-light">Effort: ${story.effort_estimate}</small>
                    </div>
                    <div class="card-body">
                        <p class="card-text">${story.description}</p>
                        <h6>Acceptance Criteria:</h6>
                        <ul class="small">
                            ${story.acceptance_criteria.map(criteria => `<li>${criteria}</li>`).join('')}
                        </ul>
                    </div>
                </div>
            </div>
            `;
        });
        
        html += `
                </div>
            </div>
        </div>
        `;
    });
    
    console.log('Generated HTML:', html);
    container.innerHTML = html;
}

function exportRequirements() {
    if (generatedEpics.length === 0) {
        alert('No requirements to export');
        return;
    }
    
    // Create exportable text format
    let exportText = `Requirements for Business Case: {{ case.code }} - {{ case.title }}\n`;
    exportText += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
    
    generatedEpics.forEach((epic, epicIndex) => {
        exportText += `EPIC ${epicIndex + 1}: ${epic.title}\n`;
        exportText += `Description: ${epic.description}\n\n`;
        
        const stories = epic.stories || epic.user_stories || [];
        stories.forEach((story, storyIndex) => {
            exportText += `  User Story ${storyIndex + 1}: ${story.title || 'User Story'}\n`;
            exportText += `  Priority: ${story.priority || 'Medium'} | Effort: ${story.effort_estimate || 'TBD'}\n`;
            exportText += `  Description: ${story.description || 'No description available'}\n`;
            exportText += `  Acceptance Criteria:\n`;
            story.acceptance_criteria.forEach(criteria => {
                exportText += `    - ${criteria}\n`;
            });
            exportText += `\n`;
        });
        
        exportText += `\n`;
    });
    
    // Download as text file
    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `requirements_{{ case.code }}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function generateTextRequirements() {
    console.log('generateTextRequirements called');
    
    // Validate that all questions are answered
    const answers = {};
    let allAnswered = true;
    
    for (let i = 1; i <= 8; i++) {
        const answer = document.getElementById(`q${i}`).value.trim();
        if (!answer) {
            allAnswered = false;
            break;
        }
        answers[`q${i}`] = answer;
    }
    
    if (!allAnswered) {
        alert('Please answer all 8 questions before generating requirements.');
        return;
    }
    
    // Hide step 2 and show text requirements
    document.getElementById('step2').style.display = 'none';
    
    // Generate structured text requirements
    const textRequirements = `REQUIREMENTS DOCUMENT
Business Case: {{ case.title }}
Generated: ${new Date().toLocaleString()}

=== FUNCTIONAL REQUIREMENTS ===
${answers.q1}

=== USER ROLES & PERMISSIONS ===
${answers.q2}

=== INTEGRATION & DATA FLOW ===
${answers.q3}

=== PERFORMANCE & SCALABILITY ===
${answers.q4}

=== REPORTING & AUDIT ===
${answers.q5}

=== ERROR HANDLING & VALIDATION ===
${answers.q6}

=== UI/UX & ACCESSIBILITY ===
${answers.q7}

=== SECURITY & COMPLIANCE ===
${answers.q8}

=== SUMMARY ===
This requirements document outlines the comprehensive functional and non-functional requirements for {{ case.title }}. The system should deliver ${answers.q1.substring(0, 100)}... while maintaining high standards for security, performance, and user experience.

=== NEXT STEPS ===
1. Review and refine these requirements with stakeholders
2. Generate detailed epics and user stories for development
3. Create technical specifications and architecture design
4. Plan implementation phases and timelines`;

    document.getElementById('textRequirementsContent').textContent = textRequirements;
    document.getElementById('textRequirementsResults').style.display = 'block';
    console.log('Text requirements displayed successfully');
    
    // Store for later use
    window.currentRequirements = textRequirements;
    window.currentAnswers = answers;
}

function generateEpicsFromRequirements() {
    if (!window.currentAnswers) {
        alert('Please generate requirements first.');
        return;
    }
    
    // Hide text requirements and show loading
    document.getElementById('textRequirementsResults').style.display = 'none';
    document.getElementById('loadingEpicsState').style.display = 'block';
    
    // Call the API to generate epics and user stories
    fetch(`/api/ai/generate-requirements/{{ case.id }}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            answers: window.currentAnswers,
            case_id: {{ case.id }}
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingEpicsState').style.display = 'none';
        
        if (data.success) {
            generatedEpics = data.epics;
            console.log('Epics received:', data.epics);
            console.log('API response message:', data.message);
            displayRequirements(data.epics, data.fallback || (data.message && data.message.includes('Fallback')));
            document.getElementById('epicRequirementsResults').style.display = 'block';
            showSuccessNotification(data.message || 'Requirements generated and saved successfully!');
        } else {
            console.error('API returned error:', data.error);
            alert('Error generating epics: ' + data.error);
            document.getElementById('textRequirementsResults').style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('loadingEpicsState').style.display = 'none';
        console.error('Error generating epics:', error);
        
        // Check if it's a network/timeout error
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            alert('Network error: Failed to connect to AI service. Please check your connection and try again.');
        } else if (error.message.includes('timeout')) {
            alert('Request timeout: AI service is taking too long. Please try again.');
        } else {
            alert('Failed to generate epics:\n' + (error.message || 'Unknown error. Please try again.'));
        }
        
        document.getElementById('textRequirementsResults').style.display = 'block';
    });
}

function backToTextRequirements() {
    document.getElementById('epicRequirementsResults').style.display = 'none';
    document.getElementById('textRequirementsResults').style.display = 'block';
}

function downloadTextRequirements() {
    if (!window.currentRequirements) {
        alert('No requirements to download.');
        return;
    }
    
    const blob = new Blob([window.currentRequirements], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `requirements_{{ case.code }}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function createProject() {
    if (generatedEpics.length === 0) {
        alert('No requirements available to create project');
        return;
    }
    
    if (confirm('This will create a new project based on these requirements. Continue?')) {
        // Redirect to project creation with pre-populated data
        const params = new URLSearchParams();
        params.append('business_case_id', '{{ case.id }}');
        params.append('auth_token', '{{ request.args.get("auth_token") }}');
        params.append('requirements', JSON.stringify(generatedEpics));
        
        window.location.href = `/projects/new?${params.toString()}`;
    }
}

// AI Draft Requirements Functions
function generateAIDraft() {
    const caseId = document.querySelector('[data-case-id]').getAttribute('data-case-id');
    const submitBtn = document.getElementById('aiDraftReqBtn');
    
    if (!submitBtn) {
        console.error('AI Draft button not found');
        return;
    }
    
    // Show loading state
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> AI Drafting...';
    submitBtn.disabled = true;
    
    // Generate AI draft requirements based on business case context
    fetch(`/api/ai/generate-ai-draft/${caseId}`, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        console.log('AI Draft response:', result);
        if (result.success && result.requirements) {
            populateFormWithAIDraft(result.requirements);
            showAlert('AI Draft Complete! Review and modify the populated requirements below.', 'success');
        } else {
            showAlert('Failed to generate AI draft: ' + (result.error || 'Unknown error'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error generating AI draft:', error);
        showAlert('Failed to generate AI draft. Using fallback requirements.', 'warning');
        populateFormWithFallback();
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Functions for handling existing requirements
function showRegenerateWizard() {
    if (confirm('This will clear existing requirements and start over. Are you sure?')) {
        // Hide the existing epics display and show the wizard
        document.querySelector('#savedRequirements').closest('.card').style.display = 'none';
        document.getElementById('requirementsWizardCard').style.display = 'block';
        
        // Reset wizard to step 1
        nextStep(1);
    }
}

function exportExistingRequirements() {
    // Get case data
    const caseCode = '{{ case.code }}';
    const caseTitle = '{{ case.title }}';
    
    // Create exportable text format from existing epics
    let exportText = `Requirements for Business Case: ${caseCode} - ${caseTitle}\n`;
    exportText += `Generated on: ${new Date().toLocaleDateString()}\n\n`;
    
    // Extract epics from the saved requirements display
    const epicCards = document.querySelectorAll('#savedRequirements .card');
    epicCards.forEach((card, epicIndex) => {
        const epicTitle = card.querySelector('.card-header').textContent.replace('Epic:', '').trim();
        const epicDesc = card.querySelector('.card-body > p').textContent.trim();
        
        exportText += `EPIC ${epicIndex + 1}: ${epicTitle}\n`;
        exportText += `Description: ${epicDesc}\n\n`;
        
        // Extract user stories
        const stories = card.querySelectorAll('.card-body li');
        stories.forEach((story, storyIndex) => {
            const storyTitle = story.querySelector('.text-warning').textContent;
            const storyDesc = story.querySelector('.text-light').textContent;
            const priority = story.querySelector('.badge.bg-danger, .badge.bg-warning, .badge.bg-success').textContent;
            const effort = story.querySelector('.badge.bg-secondary').textContent;
            
            exportText += `  User Story ${storyIndex + 1}: ${storyTitle}\n`;
            exportText += `  Priority: ${priority} | Effort: ${effort}\n`;
            exportText += `  Description: ${storyDesc}\n\n`;
        });
        
        exportText += `\n`;
    });
    
    // Download the file
    const blob = new Blob([exportText], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `requirements_${caseCode}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

// Initialize page based on whether epics exist
document.addEventListener('DOMContentLoaded', function() {
    if (!document.getElementById('savedRequirements')) {
        // Only bind AI Draft and Generate handlers when no saved requirements exist
        const aiDraftBtn = document.getElementById('aiSuggestAnswersBtn');
        const generateBtn = document.getElementById('generateReqBtn');
        
        if (aiDraftBtn) {
            aiDraftBtn.addEventListener('click', generateAIDraft);
        }
        
        if (generateBtn) {
            generateBtn.addEventListener('click', function() {
                // Start the requirements generation wizard
                nextStep(1);
            });
        }
    }
    
    // Handle refine requirements button for BA users
    const refineBtn = document.getElementById('refineRequirementsBtn');
    if (refineBtn) {
        refineBtn.addEventListener('click', function() {
            // Open the BA refinement UI or regenerate wizard
            showRegenerateWizard();
        });
    }
});

function finishWizard() {
    // Save final answer
    wizardAnswers[wizardStep] = document.getElementById('wizard-answer').value;
    
    // Filter out empty answers and populate the main form
    const nonEmptyAnswers = wizardAnswers.filter(answer => answer && answer.trim());
    
    if (nonEmptyAnswers.length === 0) {
        alert('Please provide at least one answer before finishing the wizard.');
        return;
    }
    
    // Populate the main form with wizard answers
    const form = document.getElementById('requirementsForm');
    const textareas = form.querySelectorAll('textarea');
    
    nonEmptyAnswers.forEach((answer, index) => {
        if (index < textareas.length) {
            textareas[index].value = answer;
        }
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('aiReqModal'));
    modal.hide();
    
    // Show success message
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle"></i>
        <strong>Wizard Complete!</strong> Your answers have been populated in the form below. Review and modify as needed, then generate requirements.
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const step2 = document.getElementById('step2');
    step2.insertBefore(alert, step2.querySelector('form'));
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
</script>

<!-- Load AI requirements functionality -->
<script src="/static/js/case_requirements_ai.js"></script>

<style>
.wizard-step {
    min-height: 400px;
}

.card-header.bg-primary {
    border-bottom: 1px solid rgba(255,255,255,0.2);
}

.card.border-danger {
    border-color: #dc3545 !important;
}

.card.border-warning {
    border-color: #ffc107 !important;
}

.card.border-secondary {
    border-color: #6c757d !important;
}

.spinner-border {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}