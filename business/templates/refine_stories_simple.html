{% extends 'base.html' %}

{% block title %}Refine Stories - {{ business_case.title }}{% endblock %}

{% block head %}
<style>
/* Fix dropdown text visibility in dark theme */
#storyPriority {
    color: #ffffff !important;
    background-color: #212529 !important;
    border-color: #6c757d !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
}

#storyPriority option {
    color: #000000 !important;
    background-color: #ffffff !important;
    font-weight: normal !important;
    padding: 8px 12px !important;
}

/* Force text color on selected value */
#storyPriority:focus,
#storyPriority:active {
    color: #ffffff !important;
    background-color: #212529 !important;
}

/* Priority select styling with maximum specificity */
.priority-select,
.priority-select:focus,
.priority-select:active,
.priority-select:hover {
    color: #ffffff !important;
    background-color: #212529 !important;
    border-color: #6c757d !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") !important;
}

.priority-select option {
    color: #000000 !important;
    background-color: #ffffff !important;
}

/* Force dropdown option visibility for all browsers */
.priority-select option:hover,
.priority-select option:focus,
.priority-select option:active {
    color: #000000 !important;
    background-color: #e9ecef !important;
}

/* Additional specificity for option elements */
select.priority-select option {
    color: #000000 !important;
    background-color: #ffffff !important;
    padding: 4px 8px !important;
}

/* General form select styling for dark theme */
.modal .form-select {
    color: #ffffff !important;
    background-color: #212529 !important;
    border-color: #6c757d !important;
}

.modal .form-select option {
    color: #000000 !important;
    background-color: #ffffff !important;
    padding: 8px 12px !important;
}

/* Force dropdown list styling */
select option {
    color: #000000 !important;
    background-color: #ffffff !important;
}

/* Ensure flash messages are visible */
.alert {
    color: #fff !important;
}

.alert-success {
    background-color: #0f5132 !important;
    border-color: #0a4128 !important;
}

.alert-danger {
    background-color: #842029 !important;
    border-color: #721c24 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <h2><i class="fas fa-edit me-2"></i>Refine Requirements - {{ business_case.title }}</h2>
            <p class="text-muted">Edit epics and user stories for {{ business_case.code }}</p>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    {% if current_user.role.value in ['Manager', 'Director', 'CEO', 'BA'] %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title"><i class="fas fa-tasks me-2"></i>Bulk Actions</h6>
                    <div class="btn-group" role="group">
                        <button class="btn btn-outline-warning" onclick="submitAllDraftEpics()" title="Submit all Draft epics for review">
                            <i class="fas fa-paper-plane me-2"></i>Submit All Draft Epics
                        </button>
                        <button class="btn btn-outline-secondary" onclick="saveAllChanges()" title="Save all pending changes">
                            <i class="fas fa-save me-2"></i>Save All Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if epics %}
    <!-- Epics and Stories Display -->
    <div class="row">
        {% for epic in epics %}
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group me-2"></i>{{ epic.title }}
                            {% if epic.project_id %}
                                <span class="badge bg-success ms-2">✅ Synced to Project</span>
                            {% else %}
                                <span class="badge bg-secondary ms-2">⚠️ Not Synced</span>
                            {% endif %}
                            <span class="badge bg-dark text-white ms-2" id="story-count-{{ epic.id }}">{{ epic.stories|length }} stories</span>
                        </h5>
                        {% if epic.description %}
                        <small>{{ epic.description }}</small>
                        {% endif %}
                        {% if epic.status %}
                        <div class="mt-2">
                            <span class="badge 
                                {% if epic.status == 'Draft' %}bg-secondary
                                {% elif epic.status == 'Submitted' %}bg-warning text-dark
                                {% elif epic.status == 'Approved' %}bg-success
                                {% elif epic.status == 'Rejected' %}bg-danger
                                {% endif %}">
                                Status: {{ epic.status }}
                            </span>
                            {% if epic.assigned_by %}
                            <span class="badge bg-info text-dark ms-1">Assigned by: {{ epic.assigned_by }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="btn-group btn-group-sm">
                        {% if epic.status != 'Approved' %}
                        <button class="btn btn-outline-success btn-sm" onclick="generateWithAI('{{ epic.title }}', '{{ epic.description or '' }}', {{ epic.id }})" title="AI: Suggest Stories"
                                {% if epic.status == 'Approved' %}disabled{% endif %}>
                            ✨ AI: Suggest Stories
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="loadStories({{ epic.id }})" title="View Stories">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="editEpic({{ epic.id }})" title="Edit Epic" 
                                data-epic-id="{{ epic.id }}" data-epic-title="{{ epic.title }}" data-epic-description="{{ epic.description or '' }}" data-epic-assigned-by="{{ epic.assigned_by or '' }}"
                                {% if epic.status == 'Approved' %}disabled{% endif %}>
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm" onclick="addStoryToEpic({{ epic.id }})" title="Add Story"
                                {% if epic.status == 'Approved' %}disabled{% endif %}>
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteEpic({{ epic.id }})" title="Delete Epic"
                                {% if epic.status == 'Approved' %}disabled{% endif %}>
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                        
                        <!-- Workflow buttons -->
                        {% if epic.status == 'Draft' and current_user.role.value in ['Manager', 'Director', 'CEO', 'BA'] %}
                        <button class="btn btn-outline-warning btn-sm" onclick="submitEpic({{ epic.id }})" title="Submit for Review">
                            <i class="fas fa-paper-plane"></i> Submit
                        </button>
                        {% endif %}
                        
                        {% if epic.status == 'Submitted' and current_user.role.value in ['Manager', 'Director', 'CEO'] %}
                        <button class="btn btn-outline-success btn-sm" onclick="approveEpic({{ epic.id }})" title="Approve Epic">
                            <i class="fas fa-check"></i> Approve
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="rejectEpic({{ epic.id }})" title="Reject Epic">
                            <i class="fas fa-times"></i> Reject
                        </button>
                        {% endif %}
                        
                        {% if epic.status == 'Rejected' and current_user.role.value in ['Manager', 'Director', 'CEO', 'BA'] %}
                        <button class="btn btn-outline-secondary btn-sm" onclick="resetEpic({{ epic.id }})" title="Reset to Draft">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        {% endif %}
                        
                        <!-- Comments button -->
                        <button class="btn btn-outline-info btn-sm" onclick="toggleComments({{ epic.id }})" title="Toggle Comments">
                            <i class="fas fa-comments"></i> Comments
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Dynamic Stories Container with Filters -->
                    <div class="mb-3">
                        <!-- Filter Controls -->
                        <div id="filters-{{ epic.id }}" class="row mb-3" style="display: none;">
                            <div class="col-md-4">
                                <label class="form-label text-light">Filter by Status:</label>
                                {% from 'macros/forms.html' import status_dropdown %}
                                {{ status_dropdown('status-filter-' + epic.id|string, 
                                                  ['New', 'In Progress', 'Done'], 
                                                  placeholder='All Statuses',
                                                  onchange='applyFilters(' + epic.id|string + ')') }}
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-light">Filter by Stakeholder:</label>
                                <input type="text" class="form-control" id="stakeholder-filter-{{ epic.id }}" 
                                       placeholder="Enter stakeholder name" onchange="applyFilters({{ epic.id }})">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-outline-secondary" onclick="clearFilters({{ epic.id }})">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI Output Container -->
                        <div id="ai-output-{{ epic.id }}" class="mb-3" style="display: none;"></div>
                        
                        <!-- Stories Display -->
                        <div id="stories-{{ epic.id }}" class="stories-container"></div>
                        
                        <!-- Load More Button -->
                        <div id="load-more-container-{{ epic.id }}" class="text-center mt-3" style="display: none;">
                            <button class="btn btn-outline-primary" onclick="loadMoreStories({{ epic.id }})">
                                <i class="fas fa-plus"></i> Load More Stories
                            </button>
                        </div>
                        
                        <!-- Epic Comments Section -->
                        <div id="comments-section-{{ epic.id }}" class="mt-4 border-top pt-3" style="display: none;">
                            <h6 class="text-light mb-3">
                                <i class="fas fa-comments me-2"></i>Epic Comments
                            </h6>
                            
                            <!-- Add Comment Form -->
                            <form action="{{ url_for('business.add_epic_comment', epic_id=epic.id) }}" method="POST" class="mb-3">
                                <div class="row">
                                    <div class="col-md-10">
                                        <textarea name="message" class="form-control" rows="3" 
                                                  placeholder="Add a comment..." required></textarea>
                                    </div>
                                    <div class="col-md-2 d-flex align-items-start">
                                        <button type="submit" class="btn btn-outline-primary">
                                            <i class="fas fa-paper-plane"></i> Post
                                        </button>
                                    </div>
                                </div>
                            </form>
                            
                            <!-- Comments Display -->
                            <div id="comments-list-{{ epic.id }}" class="comments-list">
                                {% if epic.comments %}
                                    {% for comment in epic.comments %}
                                    <div class="comment-item mb-3 p-3 border rounded" style="background-color: #2a2a2a; border-color: #444;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <strong class="text-info">{{ comment.author }}</strong>
                                            <small class="text-muted">{{ comment.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                        </div>
                                        <p class="text-light mb-0">{{ comment.message }}</p>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-muted">No comments yet. Be the first to comment!</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Hidden static stories for editing functionality -->
                    <div id="static-stories-{{ epic.id }}" style="display: none;">
                    {% if epic.stories %}
                    <div class="row">
                        {% for story in epic.stories %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-secondary">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">
                                            <i class="fas fa-book-open me-1"></i>{{ story.title }}
                                            {% if story.priority %}
                                            <span class="badge bg-info ms-2">{{ story.priority.value }}</span>
                                            {% endif %}
                                        </h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="editStory({{ story.id }})" title="Edit Story"
                                                    data-story-id="{{ story.id }}" data-epic-id="{{ epic.id }}"
                                                    data-story-title="{{ story.title }}" data-story-description="{{ story.description or '' }}"
                                                    data-story-criteria="{{ story.acceptance_criteria or '' }}" 
                                                    data-story-priority="{{ story.priority.value if story.priority else 'Medium' }}"
                                                    data-story-points="{{ story.story_points or '' }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="deleteStory({{ story.id }}, {{ epic.id }})" title="Delete Story">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% if story.description %}
                                    <p class="card-text small">{{ story.description }}</p>
                                    {% endif %}
                                    
                                    {% if story.acceptance_criteria %}
                                    <div class="small text-muted">
                                        <strong>Acceptance Criteria:</strong>
                                        <div>{{ story.acceptance_criteria }}</div>
                                    </div>
                                    {% endif %}
                                    
                                    {% if story.story_points %}
                                    <div class="small text-muted mt-2">
                                        <strong>Story Points:</strong> {{ story.story_points }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted">No user stories defined for this epic yet.</p>
                    {% endif %}
                    </div> <!-- End hidden static stories -->
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle"></i> No Requirements Found</h5>
        <p class="mb-0">This business case doesn't have any epics or user stories yet. Generate requirements first from the case details page.</p>
    </div>
    {% endif %}

    <!-- Add New Epic Section -->
    <div class="row mt-4">
        <div class="col-12">
            <button type="button" class="btn btn-primary" onclick="addNewEpic()">
                <i class="fas fa-plus"></i> Add New Epic
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-end">
            <a href="{{ url_for('business.view_case', id=business_case.id) }}" class="btn btn-secondary me-2">
                <i class="fas fa-arrow-left"></i> Back to Case
            </a>
            {% if epics %}
            <button type="button" class="btn btn-success" onclick="saveAllChanges()">
                <i class="fas fa-save"></i> Save All Changes
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- Edit Epic Modal -->
<div class="modal fade" id="editEpicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Epic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editEpicForm">
                    <input type="hidden" id="epicId">
                    <div class="mb-3">
                        <label for="epicTitle" class="form-label">Epic Title</label>
                        <input type="text" class="form-control" id="epicTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="epicDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="epicDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="epicAssignedBy" class="form-label">Assigned by (name or email)</label>
                        <input type="text" class="form-control" id="epicAssignedBy" placeholder="Optional: Manager name or email">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEpic()">Save Epic</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Story Modal -->
<div class="modal fade" id="editStoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit User Story</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStoryForm">
                    <input type="hidden" id="storyId">
                    <input type="hidden" id="storyEpicId">
                    <div class="mb-3">
                        <label for="storyTitle" class="form-label">Story Title</label>
                        <input type="text" class="form-control" id="storyTitle" required>
                    </div>
                    <div class="mb-3">
                        <label for="storyDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="storyDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="storyAcceptanceCriteria" class="form-label">Acceptance Criteria</label>
                        <textarea class="form-control" id="storyAcceptanceCriteria" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="storyPriority" class="form-label">Priority</label>
                            <select class="form-select priority-select" id="storyPriority" name="storyPriority">
                                <option value="Low" style="color: #000000 !important; background-color: #ffffff !important;">Low</option>
                                <option value="Medium" selected style="color: #000000 !important; background-color: #ffffff !important;">Medium</option>
                                <option value="High" style="color: #000000 !important; background-color: #ffffff !important;">High</option>
                                <option value="Critical" style="color: #000000 !important; background-color: #ffffff !important;">Critical</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="effortEstimate" class="form-label">Effort Estimate</label>
                            <select class="form-select" id="effortEstimate" name="effortEstimate">
                                <option value="" style="color: #000000 !important; background-color: #ffffff !important;">Not specified</option>
                                <option value="XS" style="color: #000000 !important; background-color: #ffffff !important;">XS (1-2 hours)</option>
                                <option value="S" style="color: #000000 !important; background-color: #ffffff !important;">S (1-2 days)</option>
                                <option value="M" style="color: #000000 !important; background-color: #ffffff !important;">M (3-5 days)</option>
                                <option value="L" style="color: #000000 !important; background-color: #ffffff !important;">L (1-2 weeks)</option>
                                <option value="XL" style="color: #000000 !important; background-color: #ffffff !important;">XL (2+ weeks)</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveStory()">Save Story</button>
            </div>
        </div>
    </div>
</div>

<script>
const caseId = {{ business_case.id }};

// Story state management
const storyState = {};

// Enhanced story loading function with v2 API
async function loadStories(epicId) {
    const container = document.getElementById(`stories-${epicId}`);
    const filtersContainer = document.getElementById(`filters-${epicId}`);
    
    // Initialize story state for this epic
    if (!storyState[epicId]) {
        storyState[epicId] = {
            loaded: false,
            offset: 0,
            limit: 10,
            total: 0,
            stories: [],
            filters: { status: '', stakeholder: '' }
        };
    }
    
    // Toggle: if already loaded, hide/show the content
    if (storyState[epicId].loaded) {
        if (container.style.display === 'none') {
            container.style.display = 'block';
            filtersContainer.style.display = 'flex';
            document.getElementById(`load-more-container-${epicId}`).style.display = 
                storyState[epicId].stories.length < storyState[epicId].total ? 'block' : 'none';
        } else {
            container.style.display = 'none';
            filtersContainer.style.display = 'none';
            document.getElementById(`load-more-container-${epicId}`).style.display = 'none';
        }
        return;
    }

    // First load - show filters and load stories
    filtersContainer.style.display = 'flex';
    await loadStoriesV2(epicId, true);
}

// Load stories using v2 API
async function loadStoriesV2(epicId, reset = false) {
    const container = document.getElementById(`stories-${epicId}`);
    const loadMoreContainer = document.getElementById(`load-more-container-${epicId}`);
    
    if (reset) {
        storyState[epicId].offset = 0;
        storyState[epicId].stories = [];
        container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading stories...</div>';
    }
    
    try {
        // Build API URL with pagination and filters
        const params = new URLSearchParams({
            epic_id: epicId,
            limit: storyState[epicId].limit,
            offset: storyState[epicId].offset
        });
        
        if (storyState[epicId].filters.status) {
            params.append('status', storyState[epicId].filters.status);
        }
        if (storyState[epicId].filters.stakeholder) {
            params.append('stakeholder', storyState[epicId].filters.stakeholder);
        }
        
        const res = await fetch(`/api/stories/v2?${params}`, {
            credentials: 'same-origin'
        });
        
        if (!res.ok) {
            throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        
        // Update state
        storyState[epicId].total = data.total;
        storyState[epicId].stories = reset ? data.stories : [...storyState[epicId].stories, ...data.stories];
        storyState[epicId].loaded = true;
        
        // Render stories
        renderStories(epicId);
        
        // Show/hide load more button
        const hasMore = storyState[epicId].stories.length < storyState[epicId].total;
        loadMoreContainer.style.display = hasMore ? 'block' : 'none';
        
    } catch (error) {
        console.error('Error loading stories:', error);
        container.innerHTML = '<div class="text-danger">Error loading stories.</div>';
    }
}

// Render stories to the container
function renderStories(epicId) {
    const container = document.getElementById(`stories-${epicId}`);
    const stories = storyState[epicId].stories;
    
    if (stories.length === 0) {
        container.innerHTML = `
            <div class="text-muted mb-2">No stories found for this epic.</div>
            <button class="btn btn-sm btn-outline-success" onclick="addStoryToEpic(${epicId})">
                <i class="fas fa-plus"></i> Add New Story
            </button>
        `;
        return;
    }
    
    const storiesHtml = stories.map(s => `
        <div class="story-card border rounded p-3 mb-2" style="background-color: #2a2a2a; border-color: #444 !important;">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="story-title text-light mb-1" style="color: #fff !important;">${s.title}</h6>
                <div class="story-actions">
                    <button class="btn btn-sm btn-outline-primary me-1" 
                            onclick="editStory(this)" 
                            data-story-id="${s.id}" 
                            data-epic-id="${epicId}"
                            data-story-title="${s.title}"
                            data-story-description="${s.description || ''}"
                            data-story-criteria="${s.acceptance_criteria || ''}"
                            data-story-priority="${s.priority}"
                            data-effort-estimate="${s.effort_estimate}">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStory(${s.id}, ${epicId})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="story-description text-muted mb-2" style="color: #ccc !important;">
                <small>${s.description || 'No description provided'}</small>
            </div>
            
            ${s.stakeholder ? `
            <div class="story-stakeholder mb-2">
                <strong style="color: #fff !important;">Stakeholder:</strong>
                <span class="badge bg-secondary text-light">${s.stakeholder}</span>
            </div>
            ` : ''}
            
            ${s.status ? `
            <div class="story-status mb-2">
                <strong style="color: #fff !important;">Status:</strong>
                <span class="badge ${getStatusColor(s.status)}">${s.status}</span>
            </div>
            ` : ''}
            
            ${s.acceptance_criteria ? `
            <div class="story-criteria mb-2">
                <strong style="color: #fff !important;">Acceptance Criteria:</strong>
                <div class="criteria-text text-light" style="color: #fff !important; background-color: #333; padding: 8px; border-radius: 4px; font-size: 0.9em;">
                    ${Array.isArray(s.acceptance_criteria) ? s.acceptance_criteria.map(c => `• ${c}`).join('<br>') : s.acceptance_criteria}
                </div>
            </div>
            ` : ''}
            
            <div class="story-metadata d-flex justify-content-between align-items-center">
                <span class="badge priority-${s.priority.toLowerCase()}" style="background-color: ${getPriorityColor(s.priority)}; color: #fff;">
                    ${s.priority} Priority
                </span>
                <span class="effort-badge badge bg-info text-dark" style="background-color: #17a2b8 !important; color: #000 !important;">
                    ${s.effort_estimate} effort
                </span>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = storiesHtml + `
        <div class="mt-2">
            <button class="btn btn-sm btn-outline-success" onclick="addStoryToEpic(${epicId})">
                <i class="fas fa-plus"></i> Add New Story
            </button>
        </div>
    `;
}

// Load more stories
async function loadMoreStories(epicId) {
    storyState[epicId].offset += storyState[epicId].limit;
    await loadStoriesV2(epicId, false);
}

// Apply filters
async function applyFilters(epicId) {
    const statusFilter = document.getElementById(`status-filter-${epicId}`).value;
    const stakeholderFilter = document.getElementById(`stakeholder-filter-${epicId}`).value;
    
    storyState[epicId].filters.status = statusFilter;
    storyState[epicId].filters.stakeholder = stakeholderFilter;
    
    await loadStoriesV2(epicId, true);
}

// Clear filters
async function clearFilters(epicId) {
    document.getElementById(`status-filter-${epicId}`).value = '';
    document.getElementById(`stakeholder-filter-${epicId}`).value = '';
    
    storyState[epicId].filters.status = '';
    storyState[epicId].filters.stakeholder = '';
    
    await loadStoriesV2(epicId, true);
}

// Helper function for priority colors
function getPriorityColor(priority) {
    switch(priority.toLowerCase()) {
        case 'critical': return '#dc3545';
        case 'high': return '#fd7e14';
        case 'medium': return '#198754';
        case 'low': return '#6c757d';
        default: return '#6c757d';
    }
}

// Helper function for status colors
function getStatusColor(status) {
    switch(status.toLowerCase()) {
        case 'new': return 'bg-primary';
        case 'in progress': return 'bg-warning text-dark';
        case 'done': return 'bg-success';
        default: return 'bg-secondary';
    }
}

function addNewEpic() {
    document.getElementById('epicId').value = '';
    document.getElementById('epicTitle').value = '';
    document.getElementById('epicDescription').value = '';
    document.getElementById('epicAssignedBy').value = '';
    document.querySelector('#editEpicModal .modal-title').textContent = 'Add New Epic';
    new bootstrap.Modal(document.getElementById('editEpicModal')).show();
}

function editEpic(epicId) {
    // Find the epic data on the page
    const epicCard = document.querySelector(`[onclick="editEpic(${epicId})"]`).closest('.card');
    const titleElement = epicCard.querySelector('h5');
    const descElement = epicCard.querySelector('small');
    
    // Extract data from button attributes
    const editButton = document.querySelector(`[data-epic-id="${epicId}"]`);
    const title = editButton.getAttribute('data-epic-title');
    const description = editButton.getAttribute('data-epic-description');
    const assignedBy = editButton.getAttribute('data-epic-assigned-by') || '';
    
    // Populate modal
    document.getElementById('epicId').value = epicId;
    document.getElementById('epicTitle').value = title;
    document.getElementById('epicDescription').value = description;
    document.getElementById('epicAssignedBy').value = assignedBy;
    document.querySelector('#editEpicModal .modal-title').textContent = 'Edit Epic';
    new bootstrap.Modal(document.getElementById('editEpicModal')).show();
}

function addStoryToEpic(epicId) {
    document.getElementById('storyId').value = '';
    document.getElementById('storyEpicId').value = epicId;
    document.getElementById('storyTitle').value = '';
    document.getElementById('storyDescription').value = '';
    document.getElementById('storyAcceptanceCriteria').value = '';
    document.getElementById('storyPriority').value = 'Medium';
    document.getElementById('effortEstimate').value = '';
    document.querySelector('#editStoryModal .modal-title').textContent = 'Add New Story';
    new bootstrap.Modal(document.getElementById('editStoryModal')).show();
}

function editStory(buttonElement) {
    // Extract data from the button's attributes
    const storyId = buttonElement.getAttribute('data-story-id');
    const epicId = buttonElement.getAttribute('data-epic-id');
    const title = buttonElement.getAttribute('data-story-title');
    const description = buttonElement.getAttribute('data-story-description');
    const acceptanceCriteria = buttonElement.getAttribute('data-story-criteria');
    const priority = buttonElement.getAttribute('data-story-priority');
    const effortEstimate = buttonElement.getAttribute('data-effort-estimate');
    
    // Populate modal
    document.getElementById('storyId').value = storyId;
    document.getElementById('storyEpicId').value = epicId;
    document.getElementById('storyTitle').value = title;
    document.getElementById('storyDescription').value = description;
    document.getElementById('storyAcceptanceCriteria').value = acceptanceCriteria;
    document.getElementById('storyPriority').value = priority;
    document.getElementById('effortEstimate').value = effortEstimate || '';
    
    document.querySelector('#editStoryModal .modal-title').textContent = 'Edit User Story';
    
    new bootstrap.Modal(document.getElementById('editStoryModal')).show();
}

function saveEpic() {
    const epicId = document.getElementById('epicId').value;
    const title = document.getElementById('epicTitle').value;
    const description = document.getElementById('epicDescription').value;
    const assignedBy = document.getElementById('epicAssignedBy').value;
    
    if (!title.trim()) {
        alert('Epic title is required');
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('assigned_by', assignedBy);
    
    const url = epicId ? `/api/epics/${epicId}` : '/api/epics';
    const method = epicId ? 'PUT' : 'POST';
    
    if (!epicId) {
        formData.append('case_id', caseId);
    }
    
    fetch(url, {
        method: method,
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editEpicModal')).hide();
            location.reload(); // Refresh to show changes
        } else {
            alert('Error saving epic: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error saving epic: ' + error.message);
    });
}

function saveStory() {
    const storyId = document.getElementById('storyId').value;
    const epicId = document.getElementById('storyEpicId').value;
    const title = document.getElementById('storyTitle').value;
    const description = document.getElementById('storyDescription').value;
    const acceptanceCriteria = document.getElementById('storyAcceptanceCriteria').value;
    const priority = document.getElementById('storyPriority').value;
    const effortEstimate = document.getElementById('effortEstimate').value;
    
    if (!title.trim()) {
        alert('Story title is required');
        return;
    }
    
    // Create form data
    const formData = new FormData();
    formData.append('title', title);
    formData.append('description', description);
    formData.append('acceptance_criteria', acceptanceCriteria);
    formData.append('priority', priority);
    if (effortEstimate) {
        formData.append('effortEstimate', effortEstimate);
    }
    
    const url = storyId ? `/api/stories/${storyId}` : '/api/stories';
    const method = storyId ? 'PUT' : 'POST';
    
    if (!storyId) {
        formData.append('epic_id', epicId);
    }
    
    fetch(url, {
        method: method,
        body: formData,
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editStoryModal')).hide();
            
            // Update story count badge
            updateStoryCount(epicId);
            
            // Refresh stories if they're currently displayed
            if (storyState[epicId] && storyState[epicId].loaded) {
                storyState[epicId].loaded = false; // Force refresh
                loadStories(epicId);
            }
            
            // Show success message
            showAlert(storyId ? 'Story updated successfully!' : 'Story created successfully!', 'success');
        } else {
            alert('Error saving story: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error saving story: ' + error.message);
    });
}

function deleteEpic(epicId) {
    if (confirm('Are you sure you want to delete this epic and all its stories?')) {
        fetch(`/api/epics/${epicId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error deleting epic: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting epic: ' + error.message);
        });
    }
}

function deleteStory(storyId, epicId) {
    if (confirm('Are you sure you want to delete this story?')) {
        fetch(`/api/stories/${storyId}`, {
            method: 'DELETE',
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update story count badge
                updateStoryCount(epicId);
                
                // Refresh stories if they're currently displayed
                if (storyState[epicId] && storyState[epicId].loaded) {
                    storyState[epicId].loaded = false; // Force refresh
                    loadStories(epicId);
                }
                
                // Show success message
                showAlert('Story deleted successfully!', 'success');
            } else {
                alert('Error deleting story: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting story: ' + error.message);
        });
    }
}

function addStoryToEpic(epicId) {
    // Clear the form for a new story
    document.getElementById('storyId').value = '';
    document.getElementById('storyEpicId').value = epicId;
    document.getElementById('storyTitle').value = '';
    document.getElementById('storyDescription').value = '';
    document.getElementById('storyAcceptanceCriteria').value = '';
    document.getElementById('storyPriority').value = 'Medium';
    document.getElementById('effortEstimate').value = '';
    
    // Set modal title for new story
    document.querySelector('#editStoryModal .modal-title').textContent = 'Add New User Story';
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('editStoryModal'));
    modal.show();
}

function saveAllChanges() {
    // Show confirmation and redirect back to business case
    if (confirm('Save all changes and return to business case?')) {
        // You could add actual save logic here if needed
        showAlert('All changes have been saved successfully!', 'success');
        
        // Redirect back to business case detail page after short delay
        setTimeout(() => {
            window.location.href = `/cases/${caseId}`;
        }, 1000);
    }
}

// Utility function to show alerts
function showAlert(message, type = 'info') {
    const alertContainer = document.querySelector('.container');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mt-3`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// AI story generation function
async function generateWithAI(title, description, epicId) {
    const container = document.getElementById(`ai-output-${epicId}`);
    container.style.display = 'block';
    container.innerHTML = "⏳ Generating suggestions...";
    
    try {
        const res = await fetch('/api/ai/generate-stories', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                epic_id: epicId,
                title: title, 
                description: description 
            })
        });

        const data = await res.json();
        if (data.success) {
            container.innerHTML = `
                <div class="card bg-dark border-success">
                    <div class="card-header bg-success text-dark">
                        <strong>🤖 AI-Generated User Stories</strong>
                        <button class="btn btn-sm btn-outline-light float-end" onclick="document.getElementById('ai-output-${epicId}').style.display='none'">×</button>
                    </div>
                    <div class="card-body">
                        <div id="ai-stories-container-${epicId}"></div>
                    </div>
                </div>
            `;
            
            const storiesContainer = document.getElementById(`ai-stories-container-${epicId}`);
            data.stories.forEach((story, i) => {
                const div = document.createElement('div');
                div.className = 'ai-story-block border border-secondary rounded p-3 mb-3';
                div.innerHTML = `
                    <h6 class="text-info">User Story ${i + 1}</h6>
                    <div class="mb-2">
                        <label class="form-label text-light">Title</label>
                        <input type="text" class="form-control" value="${story.title}" id="ai-title-${epicId}-${i}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-light">Description</label>
                        <textarea class="form-control" rows="2" id="ai-description-${epicId}-${i}">${story.description || ''}</textarea>
                    </div>
                    <div class="mb-2">
                        <label class="form-label text-light">Acceptance Criteria</label>
                        <textarea class="form-control" rows="3" id="ai-criteria-${epicId}-${i}">${Array.isArray(story.acceptance_criteria) ? story.acceptance_criteria.join('\\n') : story.acceptance_criteria || ''}</textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label text-light">Priority</label>
                            <select class="form-select" id="ai-priority-${epicId}-${i}">
                                <option value="Critical" ${story.priority === 'Critical' ? 'selected' : ''}>Critical</option>
                                <option value="High" ${story.priority === 'High' ? 'selected' : ''}>High</option>
                                <option value="Medium" ${story.priority === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option value="Low" ${story.priority === 'Low' ? 'selected' : ''}>Low</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Effort</label>
                            <select class="form-select" id="ai-effort-${epicId}-${i}">
                                <option value="XS" ${story.effort_estimate === 'XS' ? 'selected' : ''}>XS</option>
                                <option value="S" ${story.effort_estimate === 'S' ? 'selected' : ''}>S</option>
                                <option value="M" ${story.effort_estimate === 'M' ? 'selected' : ''}>M</option>
                                <option value="L" ${story.effort_estimate === 'L' ? 'selected' : ''}>L</option>
                                <option value="XL" ${story.effort_estimate === 'XL' ? 'selected' : ''}>XL</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-light">Stakeholder</label>
                            <input type="text" class="form-control" id="ai-stakeholder-${epicId}-${i}" placeholder="Enter stakeholder">
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary btn-sm" onclick="saveAIStory(${epicId}, ${i})">
                            💾 Save Story
                        </button>
                    </div>
                `;
                storiesContainer.appendChild(div);
            });
            
            // Add Import All button after all story blocks
            const importBtn = document.createElement('button');
            importBtn.className = 'btn btn-success btn-sm mt-3';
            importBtn.innerHTML = '⬇️ Import All Stories';
            importBtn.onclick = () => saveAllAIStories(epicId);
            storiesContainer.appendChild(importBtn);
            
            // Store story count for reference
            container.setAttribute('data-story-count', data.stories.length);
        } else {
            container.innerHTML = `
                <div class="alert alert-danger">
                    ❌ Error: ${data.error}
                    <button class="btn btn-sm btn-outline-danger float-end" onclick="document.getElementById('ai-output-${epicId}').style.display='none'">×</button>
                </div>
            `;
        }
    } catch (error) {
        container.innerHTML = `
            <div class="alert alert-danger">
                ❌ Error: Failed to generate stories. Please try again.
                <button class="btn btn-sm btn-outline-danger float-end" onclick="document.getElementById('ai-output-${epicId}').style.display='none'">×</button>
            </div>
        `;
        console.error('AI generation error:', error);
    }
}

// Function to save individual AI story
async function saveAIStory(epicId, i) {
    const title = document.getElementById(`ai-title-${epicId}-${i}`).value;
    const description = document.getElementById(`ai-description-${epicId}-${i}`).value;
    const criteria = document.getElementById(`ai-criteria-${epicId}-${i}`).value;
    const priority = document.getElementById(`ai-priority-${epicId}-${i}`).value;
    const effort = document.getElementById(`ai-effort-${epicId}-${i}`).value;
    const stakeholder = document.getElementById(`ai-stakeholder-${epicId}-${i}`).value;

    if (!title.trim()) {
        alert('❌ Story title is required');
        return;
    }

    try {
        const formData = new FormData();
        formData.append('epic_id', epicId);
        formData.append('title', title);
        formData.append('description', description);
        formData.append('acceptance_criteria', criteria);
        formData.append('priority', priority);
        formData.append('effortEstimate', effort);
        if (stakeholder) {
            formData.append('stakeholder', stakeholder);
        }

        const response = await fetch('/api/stories', {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
        });

        const responseData = await response.json();
        
        if (response.ok && responseData.success) {
            // Mark this story as saved
            const storyBlock = document.getElementById(`ai-title-${epicId}-${i}`).closest('.ai-story-block');
            storyBlock.style.opacity = '0.5';
            storyBlock.innerHTML += '<div class="alert alert-success mt-2">✅ Story saved successfully!</div>';
            
            // Update story count badge
            updateStoryCount(epicId);
            
            // Refresh stories if they're currently displayed
            if (storyState[epicId] && storyState[epicId].loaded) {
                await loadStoriesV2(epicId, true); // Force refresh with reset
            }
            
            showAlert(`Story "${title}" saved successfully!`, 'success');
        } else {
            alert(`❌ Failed to save story: ${responseData.error || 'Unknown error'}`);
        }
    } catch (error) {
        console.error('Error saving AI story:', error);
        alert(`❌ Error saving story: ${error.message}`);
    }
}

// Function to save all AI stories at once
async function saveAllAIStories(epicId) {
    const container = document.getElementById(`ai-output-${epicId}`);
    const count = parseInt(container.getAttribute('data-story-count')) || 0;
    let saved = 0;
    let errors = [];

    for (let i = 0; i < count; i++) {
        const title = document.getElementById(`ai-title-${epicId}-${i}`).value;
        const description = document.getElementById(`ai-description-${epicId}-${i}`).value;
        const criteria = document.getElementById(`ai-criteria-${epicId}-${i}`).value;
        const priority = document.getElementById(`ai-priority-${epicId}-${i}`).value;
        const effort = document.getElementById(`ai-effort-${epicId}-${i}`).value;
        const stakeholder = document.getElementById(`ai-stakeholder-${epicId}-${i}`).value;

        if (!title.trim()) {
            errors.push(`Story ${i + 1}: Title is required`);
            continue;
        }

        try {
            const formData = new FormData();
            formData.append('epic_id', epicId);
            formData.append('title', title);
            formData.append('description', description);
            formData.append('acceptance_criteria', criteria);
            formData.append('priority', priority);
            formData.append('effortEstimate', effort);
            if (stakeholder) {
                formData.append('stakeholder', stakeholder);
            }

            const response = await fetch('/api/stories', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });

            const responseData = await response.json();
            
            if (response.ok && responseData.success) {
                saved++;
                // Mark this story as saved
                const storyBlock = document.getElementById(`ai-title-${epicId}-${i}`).closest('.ai-story-block');
                storyBlock.style.opacity = '0.5';
                storyBlock.innerHTML += '<div class="alert alert-success mt-2">✅ Story saved!</div>';
            } else {
                errors.push(`Story ${i + 1}: ${responseData.error || 'Unknown error'}`);
            }
        } catch (error) {
            console.error('Error saving AI story:', error);
            errors.push(`Story ${i + 1}: ${error.message}`);
        }
    }

    // Show results
    if (saved > 0) {
        showAlert(`Successfully imported ${saved} stories!`, 'success');
        
        // Update story count badge
        updateStoryCount(epicId);
        
        // Refresh stories if they're currently displayed
        if (storyState[epicId] && storyState[epicId].loaded) {
            await loadStoriesV2(epicId, true); // Force refresh with reset
        }
    }
    
    if (errors.length > 0) {
        console.error('Import errors:', errors);
        showAlert(`Some stories failed to import: ${errors.slice(0, 3).join(', ')}${errors.length > 3 ? '...' : ''}`, 'warning');
    }
}

// Function to update story count badge
async function updateStoryCount(epicId) {
    try {
        const response = await fetch(`/api/stories/v2?epic_id=${epicId}&limit=1000`, {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            const countBadge = document.getElementById(`story-count-${epicId}`);
            if (countBadge) {
                countBadge.textContent = `${data.total} stories`;
            }
        }
    } catch (error) {
        console.error('Error updating story count:', error);
    }
}

// Epic workflow functions
function submitEpic(epicId) {
    if (confirm('Submit this epic for review?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/epic/${epicId}/submit`;
        document.body.appendChild(form);
        form.submit();
    }
}

function approveEpic(epicId) {
    if (confirm('Approve this epic?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/epic/${epicId}/approve`;
        document.body.appendChild(form);
        form.submit();
    }
}

function rejectEpic(epicId) {
    const reason = prompt('Please provide a reason for rejection:');
    if (reason && reason.trim()) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/epic/${epicId}/reject`;
        
        const reasonInput = document.createElement('input');
        reasonInput.type = 'hidden';
        reasonInput.name = 'reason';
        reasonInput.value = reason;
        form.appendChild(reasonInput);
        
        document.body.appendChild(form);
        form.submit();
    }
}

function resetEpic(epicId) {
    if (confirm('Reset this epic to Draft status?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/epic/${epicId}/reset`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Bulk submit all draft epics
function submitAllDraftEpics() {
    if (confirm('Submit all Draft epics for review at once?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/cases/${caseId}/epics/submit-all`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Toggle comments section
function toggleComments(epicId) {
    const section = document.getElementById(`comments-section-${epicId}`);
    if (section.style.display === 'none') {
        section.style.display = 'block';
        loadComments(epicId);
    } else {
        section.style.display = 'none';
    }
}

// Load comments via AJAX
async function loadComments(epicId) {
    try {
        const response = await fetch(`/api/epic/${epicId}/comments`, {
            credentials: 'same-origin'
        });
        
        if (response.ok) {
            const data = await response.json();
            const commentsList = document.getElementById(`comments-list-${epicId}`);
            
            if (data.comments && data.comments.length > 0) {
                commentsList.innerHTML = data.comments.map(comment => `
                    <div class="comment-item mb-3 p-3 border rounded" style="background-color: #2a2a2a; border-color: #444;">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong class="text-info">${comment.author}</strong>
                            <small class="text-muted">${new Date(comment.timestamp).toLocaleString()}</small>
                        </div>
                        <p class="text-light mb-0">${comment.message}</p>
                    </div>
                `).join('');
            } else {
                commentsList.innerHTML = '<div class="text-muted">No comments yet. Be the first to comment!</div>';
            }
        }
    } catch (error) {
        console.error('Error loading comments:', error);
    }
}
</script>

{% endblock %}