{% extends "base.html" %}
{% block title %}Executive Dashboard{% endblock %}

{% block head %}
<style>
@media print {
  .no-print { display: none !important; }
  .card { break-inside: avoid; }
  .container { max-width: none !important; }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Executive Dashboard</h2>
      <p class="text-muted mb-0">{{ organization_name }} • {{ user_role.title() }} View</p>
    </div>
    <div class="no-print">
      <div class="btn-group" role="group">
        <button class="btn btn-outline-primary btn-sm" id="btn-refresh">
          <i class="fas fa-sync-alt"></i> Refresh
        </button>
        <a class="btn btn-outline-secondary btn-sm" href="/api/metrics/csv">
          <i class="fas fa-download"></i> CSV Export
        </a>
        <button class="btn btn-outline-info btn-sm" onclick="window.print()">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
    </div>
  </div>

  <!-- Key Performance Indicators -->
  <div class="row g-3 mb-4">
    <div class="col-md-2">
      <div class="card border-primary h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-primary">Problems</h6>
          <div class="display-6 fw-bold text-primary" id="kpi-problems">—</div>
          <small class="text-muted">Total in pipeline</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-info h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-info">Business Cases</h6>
          <div class="display-6 fw-bold text-info" id="kpi-cases">—</div>
          <small class="text-muted">Developed</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-success h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-success">Approved</h6>
          <div class="display-6 fw-bold text-success" id="kpi-approved">—</div>
          <small class="text-muted">Ready for execution</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-warning h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-warning">Projects</h6>
          <div class="display-6 fw-bold text-warning" id="kpi-projects">—</div>
          <small class="text-muted">Active</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-dark h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-dark">Completed</h6>
          <div class="display-6 fw-bold text-dark" id="kpi-done">—</div>
          <small class="text-muted">Delivered</small>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card border-danger h-100">
        <div class="card-body text-center">
          <h6 class="card-title text-danger">Stalled</h6>
          <div class="display-6 fw-bold text-danger" id="kpi-stalled">—</div>
          <small class="text-muted">>14 days</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-3 mb-4">
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-funnel-dollar"></i> Portfolio Funnel</h6>
        </div>
        <div class="card-body">
          <canvas id="chart-funnel" height="200"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-chart-line"></i> ROI Performance</h6>
        </div>
        <div class="card-body">
          <canvas id="chart-roi" height="200"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Metrics Row -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="fas fa-clock"></i> Lead Time</h6>
          <div class="display-6 fw-bold" id="kpi-leadtime">—</div>
          <small class="text-muted">Average days (creation to approval)</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="fas fa-percentage"></i> Conversion Rate</h6>
          <div class="display-6 fw-bold" id="conversion-rate">—</div>
          <small class="text-muted">Problems to cases</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="fas fa-check-circle"></i> Approval Rate</h6>
          <div class="display-6 fw-bold" id="approval-rate">—</div>
          <small class="text-muted">Cases approved</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body text-center">
          <h6 class="card-title"><i class="fas fa-trophy"></i> Completion Rate</h6>
          <div class="display-6 fw-bold" id="completion-rate">—</div>
          <small class="text-muted">Projects delivered</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Activity -->
  <div class="row g-3 mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-building"></i> Department Activity</h6>
        </div>
        <div class="card-body">
          <canvas id="chart-departments" height="150"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><i class="fas fa-calendar-alt"></i> Recent Activity (30 days)</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>New Problems:</span>
            <strong id="recent-problems">—</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span>New Cases:</span>
            <strong id="recent-cases">—</strong>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Weekly Summary -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h6 class="mb-0"><i class="fas fa-robot"></i> Executive Summary</h6>
      <button class="btn btn-sm btn-outline-primary no-print" id="btn-refresh-summary">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
    <div class="card-body">
      <pre id="ai-summary" class="mb-0" style="white-space: pre-wrap; font-family: inherit;">Loading executive summary...</pre>
    </div>
  </div>

  <!-- Data timestamp -->
  <div class="text-center mt-3">
    <small class="text-muted">
      Data generated at: <span id="data-timestamp">—</span> | 
      Cache TTL: 5 minutes | 
      <a href="#" id="invalidate-cache" class="no-print">Invalidate Cache</a>
    </small>
  </div>
</div>

<!-- Drill-through Modal -->
<div class="modal fade" id="drillModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="drillModalTitle">Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex mb-2">
          <input id="drillSearch" class="form-control me-2" placeholder="Search items...">
          <button class="btn btn-sm btn-outline-primary" id="drillSearchBtn">Search</button>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-striped">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Created</th>
              </tr>
            </thead>
            <tbody id="drillTableBody">
              <tr><td colspan="3" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="d-flex justify-content-between mt-3">
          <button class="btn btn-sm btn-secondary" id="drillPrev" disabled>Previous</button>
          <span class="align-self-center" id="drillPageInfo">Page 1</span>
          <button class="btn btn-sm btn-secondary" id="drillNext">Next</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script defer src="{{ url_for('static', filename='js/executive_charts.js') }}"></script>
<script>
  window.__ORG_ID__ = {{ org_id|tojson }};
  window.__USER_ROLE__ = {{ user_role|tojson }};
</script>
{% endblock %}